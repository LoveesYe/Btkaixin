var crontab={typeTips:{site:"备份网站",database:"备份数据库",logs:"切割日志",path:"备份目录",webshell:"查杀站点"},crontabForm:{name:"",type:"",where1:"",hour:"",minute:"",week:"",sType:"",sBody:"",sName:"",backupTo:"",save:"",sBody:"",urladdress:"",save_local:"",notice:"",notice_channel:""},backupList:[],editForm:false,crontabFormConfig:[{label:"任务类型",group:{type:"select",name:"sType",width:"140px",value:"toShell",list:[{title:"Shell脚本",value:"toShell"},{title:"备份网站",value:"site"},{title:"备份数据库",value:"database"},{title:"日志切割",value:"logs"},{title:"备份目录",value:"path"},{title:"木马查杀",value:"webshell"},{title:"同步时间",value:"syncTime"},{title:"释放内存",value:"rememory"},{title:"访问URL",value:"toUrl"}],unit:'<span style="margin-top: 9px; display: inline-block;"><i style="color: red;font-style: initial;font-size: 12px;margin-right: 5px">*</i>任务类型包含以下部分：Shell脚本、备份网站、备份数据库、日志切割、释放内存、访问URL、备份目录、木马查杀、同步时间</span>',change:function(d,b,c){var a=crontab.crontabsType(crontab.crontabFormConfig.concatObject(),d,c);c.$again_render_form(a)}}},{label:"任务名称",group:{type:"text",name:"name",width:"300px",placeholder:"请输入计划任务名称"}},{label:"执行周期",group:[{type:"select",name:"type",width:"90px",value:"week",list:[{title:"每天",value:"day"},{title:"N天",value:"day-n"},{title:"每小时",value:"hour"},{title:"N小时",value:"hour-n"},{title:"N分钟",value:"minute-n"},{title:"每星期",value:"week"},{title:"每月",value:"month"}],change:function(c,a,b){crontab.crontabType(b.config.form,c);b.$replace_render_content(2)}},{type:"select",name:"week",width:"90px",value:"1",list:[{title:"周一",value:"1"},{title:"周二",value:"2"},{title:"周三",value:"3"},{title:"周四",value:"4"},{title:"周五",value:"5"},{title:"周六",value:"6"},{title:"周日",value:"0"}]},{type:"number",display:false,name:"where1","class":"group",width:"70px",value:"3",unit:"日",min:1,max:31},{type:"number",name:"hour","class":"group",width:"70px",value:"1",unit:"小时",min:0,max:23},{type:"number",name:"minute","class":"group",width:"70px",min:0,max:59,value:"30",unit:"分钟"}]},{label:"备份网站",display:false,group:[{type:"select",name:"sName",width:"150px",placeholder:"无站点数据",list:{url:"/crontab?action=GetDataList",data:{type:"sites"},dataFilter:function(b){var d=[{title:"所有",value:"ALL"}];for(var a=0;a<b.data.length;a++){var c=b.data[a];d.push({title:c.name+" [ "+c.ps+" ]",value:c.name})}if(d.length===1){d=[]}return d},success:function(f,e,a){var d=[{title:"服务器磁盘",value:"localhost"}],h=e.config.form[1],g=f.data[0]?f.data[0].name:"",b=e.config.form[0].group.value;for(var c=0;c<f.orderOpt.length;c++){var j=f.orderOpt[c];d.push({title:j.name,value:j.value})}$.extend(a.group[2],{disabled:false,list:d});h.group.value=e.data.name||(crontab.typeTips[e.config.form[0].group.value]+(g?"[ "+(b==="logs"?"所有":g)+" ]":""));a.group[0].value=(b==="logs"?"ALL":g);e.$local_refresh("backupTo",a.group[2]);e.$local_refresh("name",h.group);if(g===""){e.$local_refresh("submitForm",$.extend(e.config.form[8].group,{disabled:true}))}}},change:function(d,a,b){var c=b.config.form[1];c.group.value=crontab.typeTips[d.sType]+"[ "+(d.sName==="ALL"?"所有":d.sName)+" ]";b.$local_refresh("name",c.group)}},{type:"text",width:"200px",name:"path",display:false,icon:{type:"glyphicon-folder-open",event:function(c,a,b){$("#bt_select").one("click",function(){b.config.form[1].group.value="备份目录["+a.path.val()+"]";b.$local_refresh("name",b.config.form[1].group)})}},value:bt.get_cookie("sites_path")?bt.get_cookie("sites_path"):"/www/wwwroot",placeholder:"请选择文件目录"},{type:"select",name:"backupTo",label:"备份到",width:"150px",placeholder:"无存储信息",disabled:true,value:"localhost",list:[],change:function(c,a,b){b.config.form[3].group[2].value=c.backupTo;b.config.form[3].group[4].display=c.backupTo!=="localhost"?true:false;b.$replace_render_content(3)}},{label:"保留最新",type:"number",name:"save","class":"group",width:"70px",value:"3",unit:"份"},{type:"checkbox",name:"save_local",display:false,style:{"margin-top":"7px"},value:"0",title:"同时保留本地备份（和云存储保留份数一致）",event:function(c,a,b){b.config.form[3].group[4].value=!c.save_local?"0":"1"}}]},{label:"备份提醒",display:false,group:[{type:"select",name:"notice",value:0,list:[{title:"不接收任何消息通知",value:0},{title:"任务执行失败接收通知",value:1}],change:function(d,a,b){var e=b.config.form[4],c=parseInt(d.notice);e.group[1].display=!!c;e.group[0].value=c;b.$replace_render_content(4)}},{label:"消息通道",type:"select",name:"notice_channel",display:false,width:"100px",placeholder:"未配置消息通道",list:{url:"/config?action=get_settings",dataFilter:function(a,b){var c=crontab.objectEmailOrDingding.getChannelSwitch(a,b.config.form[0].group.value);b.config.form[4].group[1].value=c[0].value;return c},success:function(b,c,a,d){if(d.length===0){c.config.form[8].group.disabled=true;c.$local_refresh("submitForm",c.config.form[8].group)}}}},{type:"link","class":"mr5",title:"设置消息通道",event:function(c,a,b){layer.open({type:1,area:"600px",title:"设置消息通道",skin:"layer-alarm-channel",closeBtn:2,shift:5,shadeClose:false,content:'<div class="bt-form">							<div class="bt-w-main">								<div class="bt-w-menu">									<p class="bgw">邮箱</p>									<p>钉钉</p>								</div>								<div class="bt-w-con pd15">									<div class="conter_box active"><div class="email_alarm"></div></div>									<div class="conter_box" style="display:none">										<div class="bt-form">											<div class="line">												<span class="tname">通知全体</span>												<div class="info-r" style="height:28px; margin-left:100px">													<input class="btswitch btswitch-ios" id="panel_alert_all" type="checkbox">													<label style="position: relative;top: 5px;" class="btswitch-btn" for="panel_alert_all"></label>												</div>											</div>											<div class="line">												<span class="tname">钉钉URL</span>												<div class="info-r">													<textarea name="channel_dingding_value" class="bt-input-text mr5" type="text" style="width: 300px; height:90px; line-height:20px" placeholder="请输入钉钉URL"></textarea>												</div>												<div class="dingding_btn">													<button class="btn btn-success btn-sm save_channel_ding" style="margin: 10px 0 0 100px;">保存</button>												</div>											</div>										</div>										<ul class="help-info-text c7" style="margin-top: 170px;">											<li style="list-style:inside disc">支持钉钉/企业微信												<a class="btlink" href="https://www.bt.cn/bbs/thread-71298-1-1.html" target="_blank">《如何获取URL》</a>											</li></ul>									</div>								</div>							</div></div>',success:function(){$(".bt-w-menu p").click(function(){var d=$(this).index();$(this).addClass("bgw").siblings().removeClass("bgw");$(".conter_box").eq(d).show().siblings().hide()});$(".save_channel_ding").click(function(){var d=$("textarea[name=channel_dingding_value]").val(),e=$("#panel_alert_all").prop("checked");bt_tools.send({url:"/config?action=set_dingding",data:{url:d,atall:e==true?"True":"False"}},function(f){if(f.status){crontab.objectEmailOrDingding.renderChannelSelete(b)}bt.msg(f)},"生成钉钉通道")});crontab.objectEmailOrDingding.renderEmailList(b)}})}}]},{label:"脚本内容",group:{type:"textarea",name:"sBody",style:{width:"500px","min-width":"500px","min-height":"130px","line-height":"22px","padding-top":"10px",resize:"both","max-width":"600px","max-height":"160px"},placeholder:"请输入脚本内容"}},{label:"URL地址",display:false,group:{type:"text",width:"500px",name:"urladdress",value:"http://"}},{label:"提示",display:false,group:{type:"help",name:"webshellTips",style:{"margin-top":"6px"},list:["释放PHP、MYSQL、PURE-FTPD、APACHE、NGINX的内存占用,建议在每天半夜执行!"]}},{label:"",group:{type:"button",size:"",name:"submitForm",title:"添加任务",event:function(c,a,b){c.save_local=b.config.form[3].group[4].value;b.submit(c)}}}],crontabsType:function(a,c,b){switch(c.sType){case"toShell":break;case"database":a[3].group[0].placeholder="无数据库数据";a[3].group[0].list.data.type="databases";a[5].display=false;case"logs":if(c.sType==="logs"){a[2].group[0].value="day";a[2].group[1].display=false;a[3].group[2].display=false;a[3].group[3].value=180}case"path":if(c.sType==="path"){a[1].group.value="备份目录["+a[3].group[1].value+"]";a[2].group[0].value="day";a[2].group[1].display=false;a[3].group[0].display=false;a[3].group[1].display=true;a[3].group[2].disabled=false;a[3].group[2].list={url:"/crontab?action=GetDataList",data:{type:"sites"},dataFilter:function(e){var g=[{title:"服务器磁盘",value:"localhost"}];for(var d=0;d<e.orderOpt.length;d++){var f=e.orderOpt[d];g.push({title:f.name,value:f.value})}crontab.backupList=e;return g}}}case"webshell":if(c.sType==="webshell"){a[3].group[0].unit='<span style="margin-top: 9px; display: inline-block;">*本次查杀由长亭牧云强力驱动</span>';a[3].group[2].display=false;a[3].group[3].display=false;a[4].display=true;a[4].label="消息通道";a[4].group[0].display=false;delete a[4].group[1].label;a[4].group[1].display=true;a[5].display=false}case"site":a[3].label=crontab.typeTips[c.sType];if(c.sType!=="path"){a[1].group.disabled=true}a[3].display=true;if(c.sType==="database"||c.sType==="site"||c.sType==="path"){a[4].display=true}a[5].label="排除规则";a[5].group.placeholder="每行一条规则,目录不能以/结尾，示例：\ndata/config.php\nstatic/upload\n *.log\n";break;case"syncTime":a[1].group.value="定期同步服务器时间";a[5].group.value='echo "|-正在尝试从0.pool.bt.cn同步时间..";\nntpdate -u 0.pool.bt.cn\nif [ $? = 1 ];then\n\techo "|-正在尝试从1.pool.bt.cn同步时间..";\n\tntpdate -u 1.pool.bt.cn\nfi\nif [ $? = 1 ];then\n\techo "|-正在尝试从0.asia.pool.ntp.org同步时间..";\n\tntpdate -u 0.asia.pool.ntp.org\nfi\nif [ $? = 1 ];then\n\techo "|-正在尝试从www.bt.cn同步时间..";\n\tgetBtTime=$(curl -sS --connect-timeout 3 -m 60 http://www.bt.cn/api/index/get_time)\n\tif [ "${getBtTime}" ];then\t\n\t\tdate -s "$(date -d @$getBtTime +"%Y-%m-%d %H:%M:%S")"\n\tfi\nfi\necho "|-正在尝试将当前系统时间写入硬件..";\nhwclock -w\ndate\necho "|-时间同步完成!";';break;case"rememory":a[1].group.value="释放内存";a[5].display=false;a[7].display=true;break;case"toUrl":a[5].display=false;a[6].display=true;break}a[0].group.value=c.sType;return a},crontabType:function(a,b){var c=a[2];switch(b.type){case"day-n":case"month":case"day":c.group[1].display=false;$.extend(c.group[2],{display:b.type!=="day",unit:b.type==="day-n"?"天":"日"});c.group[3].display=true;break;case"hour-n":case"hour":case"minute-n":c.group[1].display=false;c.group[2].display=false;c.group[3].display=b.type==="hour-n";c.group[4].value=b.type==="minute-n"?3:30;break;case"week":c.group[1].display=true;c.group[2].display=false;c.group[3].display=true;c.group[4].value=30;break}c.group[0].value=b.type;return a},addCrontabForm:function(){var a=this;return bt_tools.form({el:"#crontabForm","class":"crontab_form",form:crontab.crontabFormConfig.concatObject(),submit:function(c){var b=$.extend(true,{},a.crontabForm);$.extend(b,c);if(b.name===""){bt.msg({status:false,msg:"计划任务名称不能为空！"});return false}if($("input[name=where1]").length>0){if($("input[name=where1]").val()>31||$("input[name=where1]").val()<1||$("input[name=where1]").val()==""){$("input[name=where1]").focus();layer.msg("请输入正确的周期范围[1-31]",{icon:2});return false}}if($("input[name=hour]").length>0){if($("input[name=hour]").val()>23||$("input[name=hour]").val()<0||$("input[name=hour]").val()==""){$("input[name=hour]").focus();layer.msg("请输入正确的周期范围[0-23]",{icon:2});return false}}if($("input[name=minute]").length>0){if($("input[name=minute]").val()>59||$("input[name=minute]").val()<0||$("input[name=minute]").val()==""){$("input[name=minute]").focus();layer.msg("请输入正确的周期范围[0-59]",{icon:2});return false}}switch(b.sType){case"syncTime":if(b.sType==="syncTime"){b.sType="toShell"}case"toShell":if(b.sBody===""){bt.msg({status:false,msg:"脚本内容不能为空！"});return false}break;case"path":b.sName=b.path;delete b.path;if(b.sName===""){bt.msg({status:false,msg:"备份目录不能为空！"});return false}break;case"toUrl":if(!bt.check_url(b.urladdress)){layer.msg(lan.crontab.input_url_err,{icon:2});$("#crontabForm input[name=urladdress]").focus();return false}break}bt_tools.send({url:"/crontab?action=AddCrontab",data:b},function(d){a.addCrontabForm.data={};a.addCrontabForm.$again_render_form(a.crontabFormConfig);a.crontabTabel.$refresh_table_list(true);bt_tools.msg(d)},"添加计划任务")}})},getDataList:function(a){bt_tools.send({url:"/crontab?action=GetDataList",data:{type:"sites"}},function(c){var e=[{title:"服务器磁盘",value:"localhost"}];for(var b=0;b<c.orderOpt.length;b++){var d=c.orderOpt[b];e.push({title:d.name,value:d.value})}crontab.backupList=e;if(a){a(c)}},"获取存储配置")},delCrontab:function(a,b){bt_tools.send({url:"/crontab?action=DelCrontab",data:{id:a.id}},function(c){bt.msg(c);if(c.status&&b){b(c)}},"删除计划任务")},startCrontabTask:function(a,b){bt_tools.send({url:"/crontab?action=StartTask",data:{id:a.id}},function(c){bt.msg(c);if(c.status&&b){b(c)}},"执行计划任务")},getCrontabLogs:function(a,b){bt_tools.send({url:"/crontab?action=GetLogs",data:{id:a.id}},function(c){if(c.status){if(b){b(c)}}else{bt.msg(c)}},"获取执行日志")},clearCrontabLogs:function(a,b){bt_tools.send({url:"/crontab?action=DelLogs",data:{id:a.id}},function(c){bt.msg(c);if(c.status&&b){b(c)}},"清空执行日志")},setCrontabStatus:function(a,b){bt_tools.send({url:"/crontab?action=set_cron_status",data:{id:a.id}},function(c){bt.msg(c);if(c.status&&b){b(c)}},"设置任务状态")},crontabTabel:function(){var a=this;return bt_tools.table({el:"#crontabTabel",url:"/crontab?action=GetCrontab",minWidth:"1000px",autoHeight:true,"default":"计划任务列表为空",height:300,dataFilter:function(b){return{data:b}},column:[{type:"checkbox","class":"",width:20},{fid:"name",title:"任务名称"},{fid:"status",title:"状态",width:80,config:{icon:true,list:[[1,"正常","bt_success","glyphicon-play"],[0,"停用","bt_danger","glyphicon-pause"]]},type:"status",event:function(f,b,e,c,d){bt.confirm({title:"设置计划任务状态",msg:parseInt(f.status)?"计划任务暂停后将无法继续运行，您真的要停用这个计划任务吗？":"该计划任务已停用，是否要启用这个计划任务"},function(){a.setCrontabStatus(f,function(){d.$refresh_table_list(true)})})}},{fid:"type",title:"周期",width:120},{fid:"cycle",title:"执行时机"},{fid:"save",title:"保存数量",template:function(b){return"<span>"+(b.save>0?+b.save+"份":"-")+"</span>"}},{fid:"backupTo",title:"备份到",width:120,template:function(e,b){for(var c=0;c<a.backupList.length;c++){var d=a.backupList[c];if(d.value===e.backupTo){return"<span>"+d.title+"</span>"}}return"<span>--</span>"}},{fid:"addtime",title:"上次执行时间"},{title:"操作",type:"group",align:"right",group:[{title:"执行",event:function(f,b,e,c,d){a.startCrontabTask(f,function(){d.$refresh_table_list(true)})}},{title:"编辑",event:function(f,b,e,c,d){layer.open({type:1,title:"编辑计划任务-["+f.name+"]",area:"850px",skin:"layer-create-content",shadeClose:false,closeBtn:2,content:'<div class="ptb20" id="editCrontabForm" style="min-height: 400px"></div>',success:function(g,h){bt_tools.send({url:"/crontab?action=get_crond_find",data:{id:f.id}},function(m){var l=crontab.crontabFormConfig.concatObject(),k=$.extend(true,{},a.crontabForm),i={};for(var j in k){if(k.hasOwnProperty.call(k,j)){k[j]=typeof m[j]==="undefined"?"":m[j]}}switch(m.type){case"day":i={where1:"",hour:m.where_hour,minute:m.where_minute};break;case"day-n":i={where1:m.where1,hour:m.where_hour,minute:m.where_minute};break;case"hour":i={where1:m.where1,hour:m.where_hour,minute:m.where_minute};break;case"hour-n":i={where1:"",hour:m.where1,minute:m.where_minute};break;case"minute-n":i={where1:"",hour:"",minute:m.where_minute};break;case"week":l[2].group[1].value=m.where1;i={where1:"",week:m.where1,hour:m.where_hour,minute:m.where_minute};break;case"month":i={where1:m.where1,where:"",hour:m.where_hour,minute:m.where_minute};break}l[3].group[2].value=m.backupTo;l[3].group[4].display=m.backupTo!="localhost";l[3].group[4].value=m.save_local;l[4].group[0].value=m.notice;l[4].group[1].display=!!m.notice;if(l[4].group[1].display){bt_tools.send({url:"/config?action=get_settings"},function(o){var n=a.objectEmailOrDingding.getChannelSwitch(o,m.sType);n=$.extend(true,{},l[4].group[1],{display:true,label:"",disabled:false,list:n});l[4].group[1]=n;l[4].group[1].value=m.notice_channel===""?n[0].value:m.notice_channel})}$.extend(k,i,{id:m.id});crontab.crontabType(l,k);crontab.crontabsType(l,k);switch(m.sType){case"path":k.path=m.sName;break}l[0].group.disabled=true;l[1].group.disabled=false;l[3].group[0].disabled=true;l[8].group.title="保存编辑";k.name=k.name.replace(/\[(.*)]/,"[ "+k.sName+" ]");delete l[0].group.unit;bt_tools.form({el:"#editCrontabForm","class":"crontab_form",form:l,data:k,submit:function(o){var n=$.extend(true,{},a.crontabForm,o,{id:m.id,sType:m.sType});if(n.name===""){bt.msg({status:false,msg:"计划任务名称不能为空！"});return false}switch(n.sType){case"syncTime":if(n.sType==="syncTime"){n.sType="toShell"}case"toShell":if(n.sBody===""){bt.msg({status:false,msg:"脚本内容不能为空！"});return false}break;case"path":n.sName=n.path;delete n.path;if(n.sName===""){bt.msg({status:false,msg:"备份目录不能为空！"});return false}break;case"toUrl":if(!bt.check_url(n.urladdress)){layer.msg(lan.crontab.input_url_err,{icon:2});$("#editCrontabForm input[name=urladdress]").focus();return false}break}switch(n.type){case"hour-n":n.where1=n.hour;n.hour="";break;case"minute-n":n.where1=n.minute;n.minute="";break}bt_tools.send({url:"/crontab?action=modify_crond",data:n},function(p){bt_tools.msg(p);layer.close(h);a.crontabTabel.$refresh_table_list(true)},"编辑计划任务")}})},"获取计划配置信息")}})}},{title:"日志",event:function(f,b,e,c,d){a.getCrontabLogs(f,function(g){layer.open({type:1,title:lan.crontab.task_log_title,area:["700px","490px"],shadeClose:false,closeBtn:2,content:'<div class="setchmod bt-form  pb70">											<pre class="crontab-log" style="overflow: auto; border: 0 none; line-height:23px;padding: 15px; margin: 0;white-space: pre-wrap; height: 405px; background-color: rgb(51,51,51);color:#f1f1f1;border-radius:0;"></pre>												<div class="bt-form-submit-btn" style="margin-top: 0">												<button type="button" class="btn btn-danger btn-sm btn-title" id="clearLogs" style="margin-right:15px;">'+lan["public"]["empty"]+'</button>												<button type="button" class="btn btn-success btn-sm btn-title" onclick="layer.closeAll()">'+lan["public"]["close"]+"</button>											</div>										</div>",success:function(){var h=g.msg===""?"当前日志为空":g.msg,i=$(".setchmod pre"),j=$(".crontab-log")[0];i.text(h);j.scrollTop=j.scrollHeight;$("#clearLogs").on("click",function(){a.clearCrontabLogs(f,function(){i.text("")})})}})})}},{title:"删除",event:function(f,b,e,c,d){bt.confirm({title:"删除计划任务",msg:"您确定要删除计划任务【"+f.name+"】，是否继续？"},function(){a.delCrontab(f,function(){d.$refresh_table_list(true)})})}}]}],tootls:[{type:"batch",positon:["left","bottom"],placeholder:"请选择批量操作",buttonValue:"批量操作",disabledSelectValue:"请选择需要批量操作的计划任务!",selectList:[{title:"执行任务",url:"/crontab?action=StartTask",load:true,param:function(b){return{id:b.id}},callback:function(b){bt.confirm({title:"批量执行任务",msg:"您确定要批量执行选中的计划任务吗，是否继续？"},function(){var c={};b.start_batch(c,function(g){var e="";for(var d=0;d<g.length;d++){var f=g[d];e+="<tr><td>"+f.name+'</td><td><div style="float:right;"><span style="color:'+(f.request.status?"#20a53a":"red")+'">'+f.request.msg+"</span></div></td></tr>"}a.crontabTabel.$batch_success_table({title:"批量执行",th:"任务名称",html:e});a.crontabTabel.$refresh_table_list(true)})})}},{title:"删除任务",url:"/crontab?action=DelCrontab",load:true,param:function(b){return{id:b.id}},callback:function(b){bt.show_confirm("批量删除计划任务","<span style='color:red'>同时删除选中的计划任务，是否继续？</span>",function(){var c={};b.start_batch(c,function(g){var e="";for(var d=0;d<g.length;d++){var f=g[d];e+="<tr><td>"+f.name+'</td><td><div style="float:right;"><span style="color:'+(f.request.status?"#20a53a":"red")+'">'+f.request.msg+"</span></div></td></tr>"}a.crontabTabel.$batch_success_table({title:"批量删除",th:"任务名称",html:e});a.crontabTabel.$refresh_table_list(true)})})}}]}]})},objectEmailOrDingding:{renderEmailList:function(b){var a=bt_tools.table({el:".email_alarm",load:true,url:"/config?action=get_settings","default":"收件者列表为空",height:"275",dataFilter:function(f,g){g.EmailObj=f;var e=f.dingding.info.msg.isAtAll=="True"?true:false,d=f.dingding.info.msg=="无信息"?"":f.dingding.info.msg.dingding_url,c=[];$("#panel_alert_all").attr("checked",e);$("textarea[name=channel_dingding_value]").val(d);if(f.dingding.dingding){$(".delding").remove();var h=$('<button class="btn btn-default btn-sm delding">清除设置</button>').click(function(){bt_tools.send({url:"/config?action=set_empty",data:{type:"dingding"}},function(i){if(i.status){a.$refresh_table_list(true)}bt.msg(i)},"清除设置")});$(".dingding_btn").append(h)}$.each(f.user_mail.mail_list,function(i,j){c.push({title:"mail",value:j})});return{data:c}},column:[{title:"收件者邮箱",fid:"value",width:300},{title:"操作",type:"group",align:"right",width:70,group:[{title:"删除",event:function(g,c,f,d,e){bt_tools.send({url:"/config?action=del_mail_list",data:{email:g.value}},function(h){if(h.status){a.$refresh_table_list(true)}bt.msg(h)},"删除收件者【"+g+"】")}}]}],tootls:[{type:"group",positon:["left","top"],list:[{title:"添加收件者",active:true,event:function(d,c){bt_tools.open({type:1,title:"添加收件者邮箱",area:"400px",btn:["创建","关闭"],content:{"class":"pd20",form:[{label:"收件者邮箱",group:[{name:"email",type:"text",value:"",width:"240px"}]}]},yes:function(e,g,f){if(e.email===""){bt_tools.msg("邮箱地址不能为空!",2);return false}bt_tools.send({url:"/config?action=add_mail_address",data:e},function(h){if(h.status){layer.close(g);a.$refresh_table_list(true)}bt.msg(h)},"创建收件人列表")}})}},{title:"发送者设置",event:function(h,g){var e=g.EmailObj.user_mail.info.msg,i=e.qq_mail==undefined?"":e.qq_mail,c=e.qq_stmp_pwd==undefined?"":e.qq_stmp_pwd,j=e.hosts==undefined?"":e.hosts,k=e.port==undefined?"":e.port;if(k==""){k=465}var d=$.inArray(parseInt(k),[25,465,587])>=0,f=["保存","关闭"];if(g.EmailObj.user_mail.user_name){f=["保存","关闭","清除设置"]}bt_tools.open({type:1,title:"设置发送者邮箱信息",area:["470px","410px"],skin:"channel_config_view",btn:f,content:{"class":"pd20",form:[{label:"发送人邮箱",group:[{name:"email",type:"text",value:i,width:"300px"}]},{label:"SMTP密码",group:[{name:"stmp_pwd",type:"password",value:c,width:"300px"}]},{label:"SMTP服务器",group:[{name:"hosts",type:"text",value:j,width:"300px"}]},{label:"端口","class":"port_selected",group:[{type:"select",name:"port",width:d?"300px":"100px",value:d?parseInt(k):"diy",style:d?{}:{"margin-top":"-7px"},list:[{value:25,title:25},{value:465,title:465},{value:578,title:578},{value:"diy",title:"自定义"}],change:function(q,p,o,m,n){var l=q.port==="diy"?true:false;o.config.form[3].group[0].width=l?"100px":"300px";o.config.form[3].group[0].style=l?{"margin-top":"-7px"}:{};o.config.form[3].group[1].hide=l?false:true;m.value=q.port==="diy"?"diy":parseInt(q.port);o.$replace_render_content(m.find_index)}},{name:"port_diy",hide:d?true:false,type:"text",value:k,width:"190px"}]},{group:{type:"help",style:{"margin-top":"35px"},list:["推荐使用465端口，协议为SSL/TLS","25端口为SMTP协议，587端口为STARTTLS协议"]}}]},yes:function(l,n,m){if(l.email===""){bt_tools.msg("邮箱地址不能为空!",2);return false}if(l.stmp_pwd===""){bt_tools.msg("SMTP密码不能为空!",2);return false}if(l.hosts===""){bt_tools.msg("SMTP服务器地址不能为空!",2);return false}if(l.port==="diy"){if(l.port_diy===""){bt_tools.msg("请输入有效的端口!",2);return false}l.port=l.port_diy}delete l.port_diy;bt_tools.send({url:"/config?action=user_mail_send",data:l},function(o){if(o.status){layer.close(n);crontab.objectEmailOrDingding.renderChannelSelete(b);a.$refresh_table_list(true)}bt.msg(o)},"生成邮箱通道")},btn3:function(m,l){bt_tools.send({url:"/config?action=set_empty",data:{type:"mail"}},function(n){if(n.status){a.$refresh_table_list(true)}bt.msg(n)},"清除设置")}})}}]}]})},renderChannelSelete:function(a){var b=this;bt_tools.send({url:"/config?action=get_settings"},function(d){var c=b.getChannelSwitch(d,a.config.form[0].group.value);c=$.extend(true,{},a.config.form[4].group[1],{display:true,label:"",disabled:false,list:c});a.config.form[8].group.disabled=false;a.$local_refresh("notice_channel",c);a.$local_refresh("submitForm",a.config.form[8].group)})},getChannelSwitch:function(f,b){var a={dingding:"钉钉",user_mail:"邮箱"},h=[{title:"全部通道",value:""}],g=[];for(var d in f){if(f.hasOwnProperty(d)){var e=d==="user_mail"?"mail":d,c=f[d];if(!c.dingding&&!c.user_name){continue}g.push(e);h.push({title:a[d],value:e})}}h[0].value=g.join(",");if(b==="webshell"){h.shift()}if(h.length===(b==="webshell"?0:1)){return[]}return h}},init:function(){var a=this;this.addCrontabForm=this.addCrontabForm();this.getDataList(function(){a.crontabTabel=a.crontabTabel()});function b(){var c=window.innerHeight-690,d=$("#crontabTabel .divtable");d.css({maxHeight:c<400?"400px":(c+"px")})}$(window).on("resize",b);setTimeout(function(){b()},500)}};